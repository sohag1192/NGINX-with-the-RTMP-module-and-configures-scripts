worker_processes auto; # Automatically adjust to CPU cores
events {
    worker_connections 1024;
}

# RTMP Configuration
rtmp {
    server {
        listen 1935; # Standard RTMP port
        chunk_size 4096;

        # Application for low-latency streaming without HLS
        application live {
            live on;
            record off;
        }

        # Application for HLS streaming
        application hls {
            live on;
            hls on;
            hls_path /tmp/hls;         # Path to store segments
            hls_fragment 3s;           # Each video segment length
            hls_playlist_length 60s;   # Total length of playlist
            
            # Optimization: cleanup old fragments to save space
            hls_cleanup on;
        }
    }
}

# HTTP Configuration for Playback
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;

    server {
        listen 80;
        server_name localhost;

        # Default web root
        location / {
            root html;
            index index.html;
        }

        # HLS playback location
        location /hls {
            # Serve HLS fragments
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            alias /tmp/hls; # Point to the /tmp directory
            
            # Prevent browser caching of the playlist
            add_header Cache-Control no-cache;

            # CORS headers (Required for web players like Video.js)
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
        }
    }
}
